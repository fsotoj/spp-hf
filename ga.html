<script>
  window.dataLayer = window.dataLayer || [];

  // 1. Redefine gtag to send messages to the parent website
  function gtag() {
    // Check if we are inside an iframe
    if (window.self !== window.top) {
      window.parent.postMessage({
        type: 'SHINY_GA_EVENT',
        payload: Array.from(arguments)
      }, '*');
    } else {
      // If opened directly, log to console for debugging
      console.warn("Direct access: Event would be sent to parent:", arguments);
    }
  }

  // 2. Initialize the time tracking variables
  // (Optional: If your other scripts expect these to exist immediately)
  gtag('js', new Date());

  // 3. Handle the Client ID
  // Instead of fetching a NEW ID, we can wait for the parent to tell us its ID
  // OR simply let the parent handle it (Recommended).
</script>